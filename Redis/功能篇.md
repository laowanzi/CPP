## 过期删除策略

Redis 是可以对 key 设置过期时间的，因此需要有相应的机制将已过期的键值对删除。

「过期字典」保存了数据库中所有 key 的过期时间。

三种过期删除策略：

* 定时删除
* 惰性删除
* 定期删除

> 定时删除

**在设置 key 的过期时间时，同时创建一个定时事件，当时间到达时，由事件处理器自动执行key的删除操作。**

优点：尽快删除，对内存最友好

缺点：会占用CPU，对CPU不友好

> 惰性删除

**不主动删除过期键，每次访问时检查，过期则删除。**

优点：对CPU友好

缺点：对内存不友好

> 定期删除

**每隔一段时间随机从数据库中取出一定数量的 key 进行检查，并删除其中的过期 key。**

优点：比较折中的策略

缺点：执行的频率不好把握

**Redis 选择「惰性删除+定期删除」这两种策略配合使用。**

> Redis 如何实现惰性删除

```c
int expireIfNeeded(redisDb *db, robj *key) {
    // 判断 key 是否过期
    if (!keyIsExpired(db,key)) return 0;
    ....
    /* 删除过期键 */
    ....
    // 如果 server.lazyfree_lazy_expire 为 1 表示异步删除，反之同步删除；
    return server.lazyfree_lazy_expire ? dbAsyncDelete(db,key) :
                                         dbSyncDelete(db,key);
}
```

Redis 在访问或者修改 key 之前，都会调用 expireIfNeeded 函数对其进行检查，检查 key 是否过期：

- 如果过期，则删除该 key，至于选择异步删除，还是选择同步删除，根据 `lazyfree_lazy_expire` 参数配置决定（Redis 4.0版本开始提供参数），然后返回 null 给客户端；
- 如果没有过期，不做任何处理，然后返回正常的键值对给客户端；

> Redis 如何实现定期删除

*1、*间隔检查的时间

默认每秒进行 10 次过期检查，此配置可通过 Redis 的配置文件 redis.conf 进行配置，配置键为 hz 它的默认值是 hz 10。

*2、*随机抽查的数量

数量是20个

流程：

1.从过期字典中随机抽取20个

2.删除过期的键值对

3.如果本轮检查超过25%的 key 过期，继续步骤1；否则留待下一轮检测，循环流程的时间上限是 25ms。

```c
do {
    //已过期的数量
    expired = 0；
    //随机抽取的数量
    num = 20;
    while (num--) {
        //1. 从过期字典中随机抽取 1 个 key
        //2. 判断该 key 是否过期，如果已过期则进行删除，同时对 expired++
    }
    
    // 超过时间限制则退出
    if (timelimit_exit) return;

  /* 如果本轮检查的已过期 key 的数量，超过 25%，则继续随机抽查，否则退出本轮检查 */
} while (expired > 20/4); 
```

## 内存淘汰策略

前面说的过期删除策略，是删除已过期的 key，而当 Redis 的运行内存已经超过 Redis 设置的最大内存之后，则会使用内存淘汰策略删除符合条件的 key，以此来保障 Redis 高效的运行。





















